<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Psykiatrisk Phrase Generator</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (til at forstå JSX i browseren) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* Skjul scrollbar for renere look men behold funktionalitet */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-900 font-sans overflow-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- IKONER ---
        const Icon = ({ children, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const Activity = ({ className }) => <Icon className={className}><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></Icon>;
        const Brain = ({ className }) => <Icon className={className}><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></Icon>;
        const Stethoscope = ({ className }) => <Icon className={className}><path d="M4.8 2.3A.3.3 0 1 0 5 2H4a2 2 0 0 0-2 2v5a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6V4a2 2 0 0 0-2-2h-1a.2.2 0 1 0 .3.3"/><path d="M8 15v1a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6v-4"/><circle cx="20" cy="10" r="2"/></Icon>;
        const FileText = ({ className }) => <Icon className={className}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></Icon>;
        const RotateCcw = ({ className }) => <Icon className={className}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></Icon>;
        const Clipboard = ({ className }) => <Icon className={className}><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/></Icon>;
        const Maximize = ({ className }) => <Icon className={className}><path d="M8 3H5a2 2 0 0 0-2 2v3"/><path d="M21 8V5a2 2 0 0 0-2-2h-3"/><path d="M3 16v3a2 2 0 0 0 2 2h3"/><path d="M16 21h3a2 2 0 0 0 2-2v-3"/></Icon>;
        const Minimize = ({ className }) => <Icon className={className}><path d="M8 3v3a2 2 0 0 1-2 2H3"/><path d="M21 8h-3a2 2 0 0 1-2-2V3"/><path d="M3 16h3a2 2 0 0 1 2 2v3"/><path d="M16 21v-3a2 2 0 0 1 2-2h3"/></Icon>;
        const CheckCircle2 = ({ className }) => <Icon className={className}><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></Icon>;
        const AlertCircle = ({ className }) => <Icon className={className}><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></Icon>;
        const XCircle = ({ className }) => <Icon className={className}><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></Icon>;
        const ToggleLeft = ({ className }) => <Icon className={className}><rect width="20" height="12" x="2" y="6" rx="6" ry="6"/><circle cx="8" cy="12" r="2"/></Icon>;
        const ToggleRight = ({ className }) => <Icon className={className}><rect width="20" height="12" x="2" y="6" rx="6" ry="6"/><circle cx="16" cy="12" r="2"/></Icon>;
        const MessageSquare = ({ className }) => <Icon className={className}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></Icon>;
        const Layers = ({ className }) => <Icon className={className}><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></Icon>;
        const Trash2 = ({ className }) => <Icon className={className}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></Icon>;

        // --- DATA ---

        const ACTUAL_PSYCH_OPTIONS = [
            { id: 'ap_reason', label: 'Søger hjælp fordi...', category: 'Henvendelse & Problem', text: 'Pt. søger hjælp nu, fordi...', isDefault: true },
            { id: 'ap_hard', label: 'Svært at håndtere', category: 'Henvendelse & Problem', text: 'Pt. har svært ved at håndtere...', isDefault: true },
            { id: 'ap_main', label: 'Fylder mest', category: 'Henvendelse & Problem', text: 'Det, der fylder mest lige nu, er... (i aftagende rækkefølge)', isDefault: true },
            { id: 'ap_onset', label: 'Symptomstart', category: 'Forløb & Historik', text: 'Symptomerne startede for... siden og har udviklet sig...', isDefault: true },
            { id: 'ap_sim_yes', label: 'Har oplevet før', category: 'Forløb & Historik', text: 'Pt. har oplevet lignende symptomer før.', exclude: ['ap_sim_no'] },
            { id: 'ap_sim_no', label: 'Aldrig oplevet før', category: 'Forløb & Historik', text: 'Pt. har ikke oplevet lignende symptomer før.', isDefault: true, exclude: ['ap_sim_yes'] },
            
            // --- NYT: SOCIALT (UDVIDET) ---
            { id: 'ap_soc_unspec', label: 'Socialt uafklaret', category: 'Sociale forhold', text: 'Sociale forhold ikke nærmere belyst.', isDefault: true, exclude: ['ap_soc_alone', 'ap_soc_cohab', 'ap_soc_kids', 'ap_soc_work', 'ap_soc_sick', 'ap_soc_pension', 'ap_soc_student'] },
            // Smart Merge Social
            { id: 'ap_soc_alone', label: 'Bor alene', category: 'Sociale forhold', text: 'Socialt: Bor alene.', exclude: ['ap_soc_unspec', 'ap_soc_cohab'], smartMerge: { prefix: 'Socialt: ', item: 'bor alene', suffix: '.' } },
            { id: 'ap_soc_cohab', label: 'Samlevende', category: 'Sociale forhold', text: 'Socialt: Er samlevende.', exclude: ['ap_soc_unspec', 'ap_soc_alone'], smartMerge: { prefix: 'Socialt: ', item: 'er samlevende', suffix: '.' } },
            { id: 'ap_soc_kids', label: 'Har børn', category: 'Sociale forhold', text: 'Socialt: Har børn.', exclude: ['ap_soc_unspec'], smartMerge: { prefix: 'Socialt: ', item: 'har børn', suffix: '.' } },
            { id: 'ap_soc_work', label: 'I arbejde', category: 'Sociale forhold', text: 'Socialt: Er i arbejde.', exclude: ['ap_soc_unspec', 'ap_soc_sick', 'ap_soc_pension', 'ap_soc_student'], smartMerge: { prefix: 'Socialt: ', item: 'er i arbejde', suffix: '.' } },
            { id: 'ap_soc_student', label: 'Studerende', category: 'Sociale forhold', text: 'Socialt: Er studerende.', exclude: ['ap_soc_unspec', 'ap_soc_work', 'ap_soc_sick', 'ap_soc_pension'], smartMerge: { prefix: 'Socialt: ', item: 'er studerende', suffix: '.' } },
            { id: 'ap_soc_sick', label: 'Sygemeldt', category: 'Sociale forhold', text: 'Socialt: Er sygemeldt.', exclude: ['ap_soc_unspec', 'ap_soc_work', 'ap_soc_pension', 'ap_soc_student'], smartMerge: { prefix: 'Socialt: ', item: 'er sygemeldt', suffix: '.' } },
            { id: 'ap_soc_pension', label: 'Førtidspension', category: 'Sociale forhold', text: 'Socialt: Modtager førtidspension.', exclude: ['ap_soc_unspec', 'ap_soc_work', 'ap_soc_sick', 'ap_soc_student'], smartMerge: { prefix: 'Socialt: ', item: 'modtager førtidspension', suffix: '.' } },

            { id: 'ap_diag_yes', label: 'Tidl. diagnose', category: 'Forløb & Historik', text: 'Pt. har tidligere fået en diagnose.', exclude: ['ap_diag_no'] },
            { id: 'ap_diag_no', label: 'Ingen tidl. diagnose', category: 'Forløb & Historik', text: 'Pt. har ikke tidligere fået en diagnose.', isDefault: true, exclude: ['ap_diag_yes'] },
            { id: 'ap_treat_yes', label: 'Tidl. behandling', category: 'Forløb & Historik', text: 'Pt. har tidligere modtaget behandling for dette.', exclude: ['ap_treat_no'] },
            { id: 'ap_treat_no', label: 'Ingen tidl. beh.', category: 'Forløb & Historik', text: 'Pt. har ikke tidligere modtaget behandling for dette.', isDefault: true, exclude: ['ap_treat_yes'] },
            { id: 'ap_tried', label: 'Afprøvet (medicin/terapi)', category: 'Forløb & Historik', text: 'Pt. har prøvet... (medicin, terapi, psykoedukation, livsstilsændringer), hvilket har...', isDefault: true },
            { id: 'ap_worse', label: 'Tilstand forværret', category: 'Udvikling & Faktorer', text: 'Tilstanden er blevet værre.', exclude: ['ap_unchanged', 'ap_better'] },
            { id: 'ap_unchanged', label: 'Tilstand uændret', category: 'Udvikling & Faktorer', text: 'Tilstanden er uændret.', isDefault: true, exclude: ['ap_worse', 'ap_better'] },
            { id: 'ap_better', label: 'Tilstand bedret', category: 'Udvikling & Faktorer', text: 'Tilstanden er blevet bedre.', exclude: ['ap_worse', 'ap_unchanged'] },
            { id: 'ap_new_symp_yes', label: 'Nye symptomer', category: 'Udvikling & Faktorer', text: 'Der er kommet nye symptomer til.', exclude: ['ap_new_symp_no'] },
            { id: 'ap_new_symp_no', label: 'Ingen nye symptomer', category: 'Udvikling & Faktorer', text: 'Der er ikke kommet nye symptomer til.', isDefault: true, exclude: ['ap_new_symp_yes'] },
            { id: 'ap_modifying', label: 'Forværres/Bedres af...', category: 'Udvikling & Faktorer', text: 'Det bliver værre af... og bedre af...', isDefault: true },
            { id: 'ap_func_unchanged', label: 'Hverdag uændret', category: 'Funktionsniveau', text: 'Hverdagen opleves som uændret.', isDefault: true, exclude: ['ap_func_impact'] },
            { id: 'ap_func_impact', label: 'Hverdag påvirket', category: 'Funktionsniveau', text: 'Hverdagen opleves som påvirket, særligt i forhold til arbejde, uddannelse eller sociale relationer, hvor...', exclude: ['ap_func_unchanged'] },
            { id: 'ap_sleep_good', label: 'Søvn god', category: 'Subjektive symptomer', text: 'Søvnen har været god.', isDefault: true, exclude: ['ap_sleep_unrest', 'ap_sleep_dist'] },
            
            // Smart Merge Sleep (Anamnese)
            { id: 'ap_sleep_unrest', label: 'Søvn urolig', category: 'Subjektive symptomer', text: 'Søvnen har været urolig.', exclude: ['ap_sleep_good'], smartMerge: { prefix: 'Søvnen har været ', item: 'urolig', suffix: '.' } },
            { id: 'ap_sleep_dist', label: 'Søvn forstyrret', category: 'Subjektive symptomer', text: 'Søvnen har været forstyrret.', exclude: ['ap_sleep_good'], smartMerge: { prefix: 'Søvnen har været ', item: 'forstyrret', suffix: '.' } },
            
            { id: 'ap_energy_high', label: 'Energi høj', category: 'Subjektive symptomer', text: 'Energiniveauet føles højt.', exclude: ['ap_energy_norm', 'ap_energy_low'] },
            { id: 'ap_energy_norm', label: 'Energi uændret', category: 'Subjektive symptomer', text: 'Energiniveauet føles uændret.', isDefault: true, exclude: ['ap_energy_high', 'ap_energy_low'] },
            { id: 'ap_energy_low', label: 'Energi lav', category: 'Subjektive symptomer', text: 'Energiniveauet føles lavt.', exclude: ['ap_energy_high', 'ap_energy_norm'] },
            { id: 'ap_cog_yes', label: 'Kognitive problemer', category: 'Subjektive symptomer', text: 'Pt. har haft problemer med at huske, holde overblik eller koncentrere sig, hvilket gør det sværere at klare daglige ting.', exclude: ['ap_cog_no'] },
            { id: 'ap_cog_no', label: 'Ingen kognitive problemer', category: 'Subjektive symptomer', text: 'Pt. har ikke haft problemer med at huske, holde overblik eller koncentrere sig.', isDefault: true, exclude: ['ap_cog_yes'] },
            
            // --- NYT: RUSMIDLER (UDVIDET) ---
            { id: 'ap_subst_none', label: 'Ingen rusmidler', category: 'Rusmidler', text: 'Benægter brug af rusmidler.', isDefault: true, exclude: ['ap_subst_alc', 'ap_subst_cann', 'ap_subst_stim', 'ap_subst_benzo', 'ap_subst_opioid'] },
            // Smart Merge Rusmidler
            { id: 'ap_subst_alc', label: 'Alkohol', category: 'Rusmidler', text: 'Angiver forbrug af alkohol.', exclude: ['ap_subst_none'], smartMerge: { prefix: 'Angiver forbrug af ', item: 'alkohol', suffix: '.' } },
            { id: 'ap_subst_cann', label: 'Cannabis', category: 'Rusmidler', text: 'Angiver forbrug af cannabis.', exclude: ['ap_subst_none'], smartMerge: { prefix: 'Angiver forbrug af ', item: 'cannabis', suffix: '.' } },
            { id: 'ap_subst_stim', label: 'Centralstimulerende', category: 'Rusmidler', text: 'Angiver forbrug af centralstimulerende stoffer.', exclude: ['ap_subst_none'], smartMerge: { prefix: 'Angiver forbrug af ', item: 'centralstimulerende stoffer', suffix: '.' } },
            { id: 'ap_subst_benzo', label: 'Benzodiazepiner', category: 'Rusmidler', text: 'Angiver forbrug af benzodiazepiner.', exclude: ['ap_subst_none'], smartMerge: { prefix: 'Angiver forbrug af ', item: 'benzodiazepiner', suffix: '.' } },
            { id: 'ap_subst_opioid', label: 'Opioider', category: 'Rusmidler', text: 'Angiver forbrug af opioider.', exclude: ['ap_subst_none'], smartMerge: { prefix: 'Angiver forbrug af ', item: 'opioider', suffix: '.' } },

            { id: 'ap_phys_yes', label: 'Fysiske gener', category: 'Somatik & Livsstil', text: 'Oplever fysiske symptomer eller sygdomme, der kan spille ind.', exclude: ['ap_phys_no'] },
            { id: 'ap_phys_no', label: 'Ingen fysiske gener', category: 'Somatik & Livsstil', text: 'Oplever ikke fysiske symptomer eller sygdomme, der kan spille ind.', isDefault: true, exclude: ['ap_phys_yes'] },
            { id: 'ap_distress_more', label: 'Mere forpint', category: 'Forpinthed & Kontrol', text: 'Føler sig mere forpint.', exclude: ['ap_distress_less', 'ap_distress_same'] },
            { id: 'ap_distress_same', label: 'Uændret forpint', category: 'Forpinthed & Kontrol', text: 'Føler sig uændret forpint.', isDefault: true, exclude: ['ap_distress_less', 'ap_distress_more'] },
            { id: 'ap_distress_less', label: 'Mindre forpint', category: 'Forpinthed & Kontrol', text: 'Føler sig mindre forpint.', exclude: ['ap_distress_more', 'ap_distress_same'] },
            { id: 'ap_ctrl_good', label: 'God kontrol', category: 'Forpinthed & Kontrol', text: 'Har god følelse af kontrol over symptomerne.', isDefault: true, exclude: ['ap_ctrl_some', 'ap_ctrl_little', 'ap_ctrl_none'] },
            { id: 'ap_ctrl_some', label: 'Nogen kontrol', category: 'Forpinthed & Kontrol', text: 'Har nogen følelse af kontrol over symptomerne.', exclude: ['ap_ctrl_good', 'ap_ctrl_little', 'ap_ctrl_none'] },
            { id: 'ap_ctrl_little', label: 'Lidt kontrol', category: 'Forpinthed & Kontrol', text: 'Har lidt følelse af kontrol over symptomerne.', exclude: ['ap_ctrl_good', 'ap_ctrl_some', 'ap_ctrl_none'] },
            { id: 'ap_ctrl_none', label: 'Ingen kontrol', category: 'Forpinthed & Kontrol', text: 'Har ingen følelse af kontrol over symptomerne.', exclude: ['ap_ctrl_good', 'ap_ctrl_some', 'ap_ctrl_little'] },
            { id: 'ap_risk_yes', label: 'Skadetanker (Ja)', category: 'Risiko & Oplevelser', text: 'Har haft tanker om at skade sig selv eller andre.', exclude: ['ap_risk_no'] },
            { id: 'ap_risk_no', label: 'Ingen skadetanker', category: 'Risiko & Oplevelser', text: 'Har ikke haft tanker om at skade sig selv eller andre.', isDefault: true, exclude: ['ap_risk_yes'] },
            { id: 'ap_psych_yes', label: 'Psykotiske oplevelser', category: 'Risiko & Oplevelser', text: 'Oplever mærkelige eller ubehagelige tanker, sanser ting, som andre ikke gør, eller føler sig påvirket af noget udefrakommende.', exclude: ['ap_psych_no'] },
            { id: 'ap_psych_no', label: 'Ingen psykotiske oplevelser', category: 'Risiko & Oplevelser', text: 'Oplever ikke mærkelige eller ubehagelige tanker, sanser ting, som andre ikke gør, eller føler sig påvirket af noget udefrakommende.', isDefault: true, exclude: ['ap_psych_yes'] },
            { id: 'ap_mot_yes', label: 'Motiveret', category: 'Motivation & Ønsker', text: 'Er motiveret for behandling.', isDefault: true, exclude: ['ap_mot_no'] },
            { id: 'ap_mot_no', label: 'Ikke motiveret', category: 'Motivation & Ønsker', text: 'Er ikke motiveret for behandling.', exclude: ['ap_mot_yes'] },
            { id: 'ap_help_yes', label: 'Ønsker hjælp', category: 'Motivation & Ønsker', text: 'Ønsker hjælp til...', isDefault: true, exclude: ['ap_help_no'] },
            { id: 'ap_help_no', label: 'Ønsker ikke hjælp', category: 'Motivation & Ønsker', text: 'Ønsker ikke hjælp til...', exclude: ['ap_help_yes'] },
            { id: 'ap_plan', label: 'Behandlingsplan', category: 'Motivation & Ønsker', text: 'Vil gerne at... indgår i en kommende behandlingsplan.', isDefault: true },
        ];


        const PSYCH_OPTIONS = [
            // --- BEVIDSTHED ---
            { id: 'orient_normal', label: 'Fuldt orienteret', category: 'Bevidsthed', text: 'Vågen, klar og orienteret i tid, sted og egne data.', isDefault: true, exclude: ['orient_confused', 'orient_delir', 'orient_sløv', 'orient_sopor', 'orient_cloud'] },
            { id: 'orient_sløv', label: 'Somnolent/Sløv', category: 'Bevidsthed', text: 'Vågen, men fremstår somnolent og sløv i kontakten.', exclude: ['orient_normal', 'orient_confused', 'orient_delir', 'orient_sopor', 'orient_cloud'] },
            { id: 'orient_sopor', label: 'Sopor', category: 'Bevidsthed', text: 'Soporøs (dybt bevidsthedssvækket), men vækbar.', exclude: ['orient_normal', 'orient_confused', 'orient_delir', 'orient_sløv', 'orient_cloud'] },
            { id: 'orient_confused', label: 'Konfus', category: 'Bevidsthed', text: 'Vågen, men fremstår konfus og desorienteret.', exclude: ['orient_normal', 'orient_delir', 'orient_sløv', 'orient_sopor', 'orient_cloud'] },
            { id: 'orient_cloud', label: 'Tågetilstand', category: 'Bevidsthed', text: 'Befinder sig i en tågetilstand med nedsat opfattelse af omverdenen.', exclude: ['orient_normal', 'orient_confused', 'orient_delir', 'orient_sløv', 'orient_sopor'] },
            { id: 'orient_delir', label: 'Delirøs', category: 'Bevidsthed', text: 'Fremstår med svingende bevidsthedsniveau, opmærksomhedsforstyrrelse og usammenhængende tale, obs delir.', exclude: ['orient_normal', 'orient_confused', 'orient_sløv', 'orient_sopor', 'orient_cloud'] },
            
            // --- ORIENTERING (NY SPECIFIKATION) ---
            { id: 'orient_auto_loss', label: 'Autopsykisk desorient.', category: 'Bevidsthed (Orientering)', text: 'Autopsykisk desorienteret (navn, data, civilstand).', exclude: ['orient_normal'] },
            { id: 'orient_allo_loss', label: 'Allopsykisk desorient.', category: 'Bevidsthed (Orientering)', text: 'Allopsykisk desorienteret (tid, sted, situation).', exclude: ['orient_normal'] },

            // --- FREMTONING ---
            { id: 'appear_normal', label: 'Normal fremtoning', category: 'Fremtoning & Adfærd', text: 'Normal fremtoning, herunder soigneret og alderssvarende påklædning.', isDefault: true, exclude: ['appear_unkept', 'appear_bizarre_dress'] },
            { id: 'appear_unkept', label: 'Usoigneret', category: 'Fremtoning & Adfærd', text: 'Fremstår usoigneret, lugtende og med mangelfuld hygiejne.', exclude: ['appear_normal'], smartMerge: { prefix: 'Fremstår ', item: 'usoigneret', suffix: '.' } },
            { id: 'appear_bizarre_dress', label: 'Bizart påklædt', category: 'Fremtoning & Adfærd', text: 'Fremstår bizart eller uhensigtsmæssigt påklædt ift. årstiden.', exclude: ['appear_normal'], smartMerge: { prefix: 'Fremstår ', item: 'bizart påklædt', suffix: '.' } },
            
            // --- HOLDNING (NY KATEGORI) ---
            { id: 'att_coop', label: 'Samarbejdsvillig', category: 'Holdning & Samarbejde', text: 'Venlig og samarbejdsvillig i kontakten.', isDefault: true, exclude: ['att_guard', 'att_hostile', 'att_suspicious', 'att_ambivalent', 'att_aggress', 'att_threat'] },
            { id: 'att_guard', label: 'Afvisende/Guarded', category: 'Holdning & Samarbejde', text: 'Fremstår afvisende og guarded.', exclude: ['att_coop'], smartMerge: { prefix: 'Fremstår ', item: 'afvisende og guarded', suffix: '.' } },
            { id: 'att_suspicious', label: 'Mistænksom', category: 'Holdning & Samarbejde', text: 'Fremstår mistænksom.', exclude: ['att_coop'], smartMerge: { prefix: 'Fremstår ', item: 'mistænksom', suffix: '.' } },
            { id: 'att_hostile', label: 'Fjendtlig', category: 'Holdning & Samarbejde', text: 'Fremstår fjendtlig.', exclude: ['att_coop'], smartMerge: { prefix: 'Fremstår ', item: 'fjendtlig', suffix: '.' } },
            { id: 'att_ambivalent', label: 'Ambivalent', category: 'Holdning & Samarbejde', text: 'Fremstår ambivalent i kontakten.', exclude: ['att_coop'], smartMerge: { prefix: 'Fremstår ', item: 'ambivalent', suffix: '.' } },
            { id: 'att_threat', label: 'Truende adfærd', category: 'Holdning & Samarbejde', text: 'Fremstår verbalt truende og grænseoverskridende.', exclude: ['att_coop'], smartMerge: { prefix: 'Fremstår ', item: 'verbalt truende og grænseoverskridende', suffix: '.' } },
            { id: 'att_aggress', label: 'Aggressiv', category: 'Holdning & Samarbejde', text: 'Fremstår fysisk aggressiv og udadreagerende.', exclude: ['att_coop'], smartMerge: { prefix: 'Fremstår ', item: 'fysisk aggressiv og udadreagerende', suffix: '.' } },

            // --- ANGST & URO ---
            { id: 'anx_none', label: 'Ingen angsttegn', category: 'Angst & Uro (Objektivt)', text: 'Ingen objektive tegn på angst eller uro.', isDefault: true, exclude: ['anx_motor', 'anx_sweat', 'anx_tremor', 'anx_hands', 'anx_hypervent'] },
            { id: 'anx_motor', label: 'Motorisk urolig', category: 'Angst & Uro (Objektivt)', text: 'Fremstår motorisk urolig.', exclude: ['anx_none'], smartMerge: { prefix: 'Fremstår ', item: 'motorisk urolig', suffix: '.' } },
            { id: 'anx_sweat', label: 'Svedende', category: 'Angst & Uro (Objektivt)', text: 'Fremstår svedende.', exclude: ['anx_none'], smartMerge: { prefix: 'Fremstår ', item: 'svedende', suffix: '.' } },
            { id: 'anx_tremor', label: 'Rystende/Tremor', category: 'Angst & Uro (Objektivt)', text: 'Fremstår rystende.', exclude: ['anx_none'], smartMerge: { prefix: 'Fremstår ', item: 'rystende', suffix: '.' } },
            { id: 'anx_hands', label: 'Piller v. hænder/tøj', category: 'Angst & Uro (Objektivt)', text: 'Sidder og piller ved hænder eller tøj.', exclude: ['anx_none'], smartMerge: { prefix: 'Sidder og ', item: 'piller ved hænder eller tøj', suffix: '.' } },
            { id: 'anx_hypervent', label: 'Hyperventilerer', category: 'Angst & Uro (Objektivt)', text: 'Hyperventilerer.', exclude: ['anx_none'], smartMerge: { prefix: 'Observeres ', item: 'hyperventilerende', suffix: '.' } },

            // --- KONTAKTFORM (UDVIDET) ---
            { id: 'contact_norm_form', label: 'Formel kontakt intakt', category: 'Kontakt', text: 'Formel kontakt er intakt.', isDefault: true, exclude: ['contact_form_bad', 'contact_distanc', 'contact_autistic', 'contact_narc', 'contact_appeal'] },
            { id: 'contact_distanc', label: 'Distancerende', category: 'Kontakt', text: 'Formel kontakt er præget af distancering.', exclude: ['contact_norm_form'], smartMerge: { prefix: 'Formel kontakt er ', item: 'præget af distancering', suffix: '.' } },
            { id: 'contact_form_bad', label: 'Afvigende formel', category: 'Kontakt', text: 'Formel kontakt er svært afvigende og usikker.', exclude: ['contact_norm_form'], smartMerge: { prefix: 'Formel kontakt er ', item: 'svært afvigende og usikker', suffix: '.' } },
            { id: 'contact_appeal', label: 'Appellerende', category: 'Kontakt', text: 'Kontakten er appellerende.', exclude: ['contact_norm_form'], smartMerge: { prefix: 'Kontakten er ', item: 'appellerende', suffix: '.' } },
            { id: 'contact_autistic', label: 'Autistisk præg', category: 'Kontakt', text: 'Kontakten er med autistisk præg (afskærmet).', exclude: ['contact_norm_form'], smartMerge: { prefix: 'Kontakten er ', item: 'præget af autistiske træk (afskærmet)', suffix: '.' } },
            { id: 'contact_narc', label: 'Narcissistisk præg', category: 'Kontakt', text: 'Kontakten er med narcissistisk præg.', exclude: ['contact_norm_form'], smartMerge: { prefix: 'Kontakten er ', item: 'præget af narcissistiske træk', suffix: '.' } },
            
            { id: 'contact_eye_norm', label: 'Øjenkontakt naturlig', category: 'Kontakt', text: 'Øjenkontakten er naturlig.', isDefault: true, exclude: ['contact_eye_avoid', 'contact_eye_stare'] },
            { id: 'contact_eye_avoid', label: 'Undvigende øjne', category: 'Kontakt', text: 'Undvigende øjenkontakt.', exclude: ['contact_eye_norm'], smartMerge: { prefix: 'Øjenkontakten er ', item: 'undvigende', suffix: '.' } },
            { id: 'contact_eye_stare', label: 'Stirrende', category: 'Kontakt', text: 'Intens, stirrende øjenkontakt.', exclude: ['contact_eye_norm'], smartMerge: { prefix: 'Øjenkontakten er ', item: 'stirrende', suffix: '.' } },

            // --- AFFEKT / FØLELSER (NY KATEGORI) ---
            { id: 'aff_adekvat', label: 'Adækvat affekt', category: 'Affekt (Følelser)', text: 'Affekten er adækvat og svinger relevant.', isDefault: true, exclude: ['aff_flat', 'aff_labil', 'aff_incong', 'aff_eksplo', 'aff_inkont', 'aff_eufor', 'aff_fatuid'] },
            { id: 'aff_flat', label: 'Affladet/Følelsesflad', category: 'Affekt (Følelser)', text: 'Affekten fremstår affladet og fattig.', exclude: ['aff_adekvat'], smartMerge: { prefix: 'Affekten fremstår ', item: 'affladet', suffix: '.' } },
            { id: 'aff_labil', label: 'Affektlabil', category: 'Affekt (Følelser)', text: 'Fremstår affektlabil.', exclude: ['aff_adekvat'], smartMerge: { prefix: 'Fremstår ', item: 'affektlabil', suffix: '.' } },
            { id: 'aff_incong', label: 'Inkongruent', category: 'Affekt (Følelser)', text: 'Affekten er inkongruent (stemmer ikke overens med tankeindhold).', exclude: ['aff_adekvat'], smartMerge: { prefix: 'Affekten er ', item: 'inkongruent', suffix: '.' } },
            { id: 'aff_eksplo', label: 'Affekteksplosiv', category: 'Affekt (Følelser)', text: 'Affekten er eksplosiv.', exclude: ['aff_adekvat'], smartMerge: { prefix: 'Affekten er ', item: 'eksplosiv', suffix: '.' } },
            { id: 'aff_inkont', label: 'Affektinkontinens', category: 'Affekt (Følelser)', text: 'Udviser affektinkontinens.', exclude: ['aff_adekvat'], smartMerge: { prefix: 'Udviser ', item: 'affektinkontinens', suffix: '.' } },
            { id: 'aff_eufor', label: 'Euforisk', category: 'Affekt (Følelser)', text: 'Affekten er euforisk.', exclude: ['aff_adekvat'], smartMerge: { prefix: 'Affekten er ', item: 'euforisk', suffix: '.' } },
            { id: 'aff_fatuid', label: 'Fatuid (Tom)', category: 'Affekt (Følelser)', text: 'Affekten er fatuid (tom).', exclude: ['aff_adekvat'], smartMerge: { prefix: 'Affekten er ', item: 'fatuid', suffix: '.' } },

            // --- STEMNINGSLEJE ---
            { id: 'mood_neutral', label: 'Neutralt', category: 'Stemningsleje', text: 'Stemningslejet vurderes neutralt.', isDefault: true, exclude: ['mood_low_light', 'mood_low_severe', 'mood_high_hypo', 'mood_high_mania', 'mood_dys'] },
            { id: 'mood_low_light', label: 'Let sænket', category: 'Stemningsleje', text: 'Stemningslejet vurderes let sænket.', exclude: ['mood_neutral', 'mood_low_severe', 'mood_high_hypo', 'mood_high_mania'] },
            { id: 'mood_low_severe', label: 'Svært sænket', category: 'Stemningsleje', text: 'Stemningslejet vurderes svært sænket/depressivt.', exclude: ['mood_neutral', 'mood_low_light', 'mood_high_hypo', 'mood_high_mania'] },
            { id: 'mood_high_hypo', label: 'Løftet/Hypoman', category: 'Stemningsleje', text: 'Stemningslejet er løftet, præget af øget energi.', exclude: ['mood_neutral', 'mood_low_light', 'mood_low_severe', 'mood_high_mania'] },
            { id: 'mood_high_mania', label: 'Manisk', category: 'Stemningsleje', text: 'Stemningslejet er udtalt løftet (manisk) med tab af hæmninger.', exclude: ['mood_neutral', 'mood_low_light', 'mood_low_severe', 'mood_high_hypo'] },
            // Smart Merge Mood
            { id: 'mood_dys', label: 'Dysforisk', category: 'Stemningsleje', text: 'Fremstår dysforisk.', summaryLabel: 'Dysfori', smartMerge: { prefix: 'Fremstår ', item: 'dysforisk', suffix: '.' } },
            { id: 'mood_irritabel', label: 'Irritabel', category: 'Stemningsleje', text: 'Fremstår irritabel og med kort lunte.', summaryLabel: 'Irritabilitet', smartMerge: { prefix: 'Fremstår ', item: 'irritabel og med kort lunte', suffix: '.' } },
            { id: 'mood_labile', label: 'Grådlabil', category: 'Stemningsleje', text: 'Fremstår grådlabil under samtalen.', summaryLabel: 'Grådlabil', smartMerge: { prefix: 'Fremstår ', item: 'grådlabil', suffix: '.' } },
            
            // --- PSYKO MOTORIK ---
            { id: 'motor_normal', label: 'Normal psykomotorik', category: 'Psykomotorik', text: 'Psykomotorisk normalt.', isDefault: true, exclude: ['motor_agit', 'motor_inhib', 'motor_restless', 'motor_catatonic'] },
            { id: 'motor_agit', label: 'Agiteret (Øget)', category: 'Psykomotorik', text: 'Psykomotorisk agiteret.', exclude: ['motor_normal', 'motor_inhib', 'motor_catatonic'] },
            { id: 'motor_inhib', label: 'Hæmmet (Nedsat)', category: 'Psykomotorik', text: 'Psykomotorisk hæmmet med nedsat mimik og gestik.', exclude: ['motor_normal', 'motor_agit', 'motor_catatonic'] },
            { id: 'motor_catatonic', label: 'Katatoni', category: 'Psykomotorik', text: 'Præget af katatoni (stivnen).', exclude: ['motor_normal', 'motor_agit', 'motor_inhib'] },
            { id: 'motor_restless', label: 'Indre uro', category: 'Psykomotorik', text: 'Angiver indre uro, men fremstår motorisk rolig.', exclude: ['motor_normal'] },
            
            // --- SPROG & TÆNKNING (FORM) ---
            { id: 'think_form_norm', label: 'Normal form/sprog', category: 'Sprog & Tænkning (Form)', text: 'Sproget er nuanceret. Talen er samlet og relevant.', isDefault: true, exclude: ['think_incoh', 'think_tang', 'think_circum', 'think_neologism', 'think_persev', 'think_flight'] },
            { id: 'think_incoh', label: 'Inkohærent', category: 'Sprog & Tænkning (Form)', text: 'Tanken er springende, præget af løse associationer og "ordsalat" (inkohærent).', exclude: ['think_form_norm'], smartMerge: { prefix: 'Tanken er præget af ', item: 'inkohærens', suffix: '.' } },
            { id: 'think_tang', label: 'Tangential', category: 'Sprog & Tænkning (Form)', text: 'Svarer tangentielt og går uden om emnet.', exclude: ['think_form_norm'], smartMerge: { prefix: 'Tanken er præget af ', item: 'tangentialitet', suffix: '.' } },
            { id: 'think_neologism', label: 'Neologismer', category: 'Sprog & Tænkning (Form)', text: 'Anvender neologismer (private ordkonstruktioner).', exclude: ['think_form_norm'], smartMerge: { prefix: 'Tanken er præget af ', item: 'neologismer', suffix: '.' } },
            { id: 'think_persev', label: 'Perseveration', category: 'Sprog & Tænkning (Form)', text: 'Præget af perseveration (gentagelser).', exclude: ['think_form_norm'], smartMerge: { prefix: 'Tanken er præget af ', item: 'perseveration', suffix: '.' } },
            { id: 'think_flight', label: 'Tankeflugt', category: 'Sprog & Tænkning (Form)', text: 'Præget af tankeflugt.', exclude: ['think_form_norm'], smartMerge: { prefix: 'Tanken er præget af ', item: 'tankeflugt', suffix: '.' } },

            { id: 'think_speed_norm', label: 'Normalt tempo', category: 'Sprog & Tænkning (Tempo)', text: 'Normal talestrøm og tempo.', isDefault: true, exclude: ['think_press', 'think_latency', 'think_block'] },
            { id: 'think_press', label: 'Talepres', category: 'Sprog & Tænkning (Tempo)', text: 'Der er udtalt talepres, svært at afbryde.', exclude: ['think_speed_norm', 'think_latency'] },
            { id: 'think_latency', label: 'Latenstid', category: 'Sprog & Tænkning (Tempo)', text: 'Svarer relevant, men med betydelig latenstid.', exclude: ['think_speed_norm', 'think_press'] },
            { id: 'think_block', label: 'Tankestop', category: 'Sprog & Tænkning (Tempo)', text: 'Oplever tankestop under samtalen.', exclude: ['think_speed_norm'] },

            // --- TÆNKNING (INDHOLD) ---
            { id: 'think_content_norm', label: 'Normalt indhold', category: 'Tænkning (Indhold)', text: 'Indholdsmæssigt relevant uden bizariteter eller neologismer.', isDefault: true, exclude: ['think_ruminate', 'think_quarrel'] },
            { id: 'think_ruminate', label: 'Ruminerende', category: 'Tænkning (Indhold)', text: 'Tankeindholdet er præget af depressive grublerier (ruminationer).', exclude: ['think_content_norm'], smartMerge: { prefix: 'Tankeindholdet er præget af ', item: 'depressive grublerier (ruminationer)', suffix: '.' } },
            { id: 'think_quarrel', label: 'Kværulerende', category: 'Tænkning (Indhold)', text: 'Tankeindholdet er præget af kværulans og misfornøjelse.', exclude: ['think_content_norm'], smartMerge: { prefix: 'Tankeindholdet er præget af ', item: 'kværulans og misfornøjelse', suffix: '.' } },

            // --- PERCEPTION ---
            { id: 'psychosis_none', label: 'Ingen hallucinationer', category: 'Perception (Hallucinationer)', text: 'Ingen tegn på produktive psykotiske symptomer, herunder ingen hallucinationer.', isDefault: true, exclude: ['hallu_audit', 'hallu_visual', 'hallu_olfact'] },
            { id: 'hallu_audit', label: 'Hørehallucinationer', category: 'Perception (Hallucinationer)', text: 'Der er evidens for hørehallucinationer (stemmer/lyde).', exclude: ['psychosis_none'], smartMerge: { prefix: 'Der er evidens for ', item: 'hørehallucinationer', suffix: '.' } },
            { id: 'hallu_visual', label: 'Synshallucinationer', category: 'Perception (Hallucinationer)', text: 'Angiver synshallucinationer.', exclude: ['psychosis_none'], smartMerge: { prefix: 'Der er evidens for ', item: 'synshallucinationer', suffix: '.' } },
            { id: 'hallu_olfact', label: 'Lugt/Smag', category: 'Perception (Hallucinationer)', text: 'Angiver lugt- eller smagshallucinationer.', exclude: ['psychosis_none'], smartMerge: { prefix: 'Der er evidens for ', item: 'lugt-/smagshallucinationer', suffix: '.' } },

            // --- VRANGFORESTILLINGER ---
            { id: 'delusion_none', label: 'Ingen vrangforestillinger', category: 'Indhold (Vrangforestillinger)', text: 'Ingen vrangforestillinger.', isDefault: true, exclude: ['delusion_para', 'delusion_megalo', 'delusion_depress', 'delusion_bizarre', 'delusion_control', 'delusion_hypo'] },
            { id: 'delusion_para', label: 'Paranoia (Persekutorisk)', category: 'Indhold (Vrangforestillinger)', text: 'Præget af paranoide (persekutoriske) vrangforestillinger og forfølgelsestanker.', exclude: ['delusion_none'], smartMerge: { prefix: 'Præget af ', item: 'paranoide (persekutoriske) vrangforestillinger', suffix: '.' } },
            { id: 'delusion_megalo', label: 'Storhed (Megaloman)', category: 'Indhold (Vrangforestillinger)', text: 'Giver udtryk for megalomane vrangforestillinger (storhedsvanvid).', exclude: ['delusion_none'], smartMerge: { prefix: 'Præget af ', item: 'megalomane vrangforestillinger', suffix: '.' } },
            { id: 'delusion_depress', label: 'Depressive/Skyld', category: 'Indhold (Vrangforestillinger)', text: 'Udviser depressive vrangforestillinger (ruin, skyld, fortabele).', exclude: ['delusion_none'], smartMerge: { prefix: 'Præget af ', item: 'depressive vrangforestillinger', suffix: '.' } },
            { id: 'delusion_hypo', label: 'Hypokondre', category: 'Indhold (Vrangforestillinger)', text: 'Udviser hypokondre vrangforestillinger.', exclude: ['delusion_none'], smartMerge: { prefix: 'Præget af ', item: 'hypokondre vrangforestillinger', suffix: '.' } },
            { id: 'delusion_control', label: 'Styring/Påvirkning', category: 'Indhold (Vrangforestillinger)', text: 'Oplever tankepåvirknings- eller styringsoplevelser.', exclude: ['delusion_none'], smartMerge: { prefix: 'Præget af ', item: 'tankepåvirknings-/styringsoplevelser', suffix: '.' } },
            
            // --- KOGNITION & HUKOMMELSE ---
            { id: 'cog_normal', label: 'Normal kognition', category: 'Kognition & Hukommelse', text: 'Kognitivt upåfaldende i samtalen. Intet tegn på hukommelsessvigt.', isDefault: true, exclude: ['cog_imp', 'cog_memory', 'cog_conc', 'cog_confab', 'cog_amnesia'] },
            { id: 'cog_imp', label: 'Kognitivt svækket', category: 'Kognition & Hukommelse', text: 'Virker generelt kognitivt svækket (intellektuel reduktion).', exclude: ['cog_normal'], smartMerge: { prefix: 'Udviser tegn på ', item: 'generel kognitiv svækkelse', suffix: '.' } },
            { id: 'cog_memory', label: 'Hukommelsesbesvær', category: 'Kognition & Hukommelse', text: 'Udviser tegn på hukommelsesbesvær (indprentning/langtid).', exclude: ['cog_normal'], smartMerge: { prefix: 'Udviser tegn på ', item: 'hukommelsesbesvær', suffix: '.' } },
            { id: 'cog_amnesia', label: 'Amnesi', category: 'Kognition & Hukommelse', text: 'Udviser tegn på amnesi (lakunær eller total).', exclude: ['cog_normal'], smartMerge: { prefix: 'Udviser tegn på ', item: 'amnesi', suffix: '.' } },
            { id: 'cog_confab', label: 'Konfabulationer', category: 'Kognition & Hukommelse', text: 'Der ses konfabulationer (udfylder hukommelseshuller med fantasi).', exclude: ['cog_normal'], smartMerge: { prefix: 'Der ses ', item: 'konfabulationer', suffix: '.' } },
            { id: 'cog_conc', label: 'Koncentrationsbesvær', category: 'Kognition & Hukommelse', text: 'Præget af koncentrationsbesvær, svært ved at fastholde fokus.', exclude: ['cog_normal'], smartMerge: { prefix: 'Udviser tegn på ', item: 'koncentrationsbesvær', suffix: '.' } },
            
            // --- INDSIGT ---
            { id: 'insight_good', label: 'God indsigt', category: 'Indsigt', text: 'Har relevant og god sygdomsindsigt.', isDefault: true, exclude: ['insight_none', 'insight_part'] },
            { id: 'insight_part', label: 'Partiel indsigt', category: 'Indsigt', text: 'Har partiel sygdomsindsigt, erkender symptomer men ikke behandlingsbehov.', exclude: ['insight_good', 'insight_none'] },
            { id: 'insight_none', label: 'Ingen indsigt', category: 'Indsigt', text: 'Ingen sygdomsindsigt.', exclude: ['insight_good', 'insight_part'] },
            
            // --- SUICIDALITET ---
            { id: 'sui_none', label: 'Ingen suicidalitet', category: 'Risikovurdering (Suic)', text: 'Ingen aktuelle tanker om død eller selvmord. Ingen selvmordsplaner eller -intentioner.', isDefault: true, exclude: ['sui_passive', 'sui_active_thoughts', 'sui_plans', 'sui_intent'] },
            { id: 'sui_passive', label: 'Passive dødstanker', category: 'Risikovurdering (Suic)', text: 'Angiver passive dødstanker/livsled ("kunne være rart ikke at vågne"), men ingen aktuelle planer eller intentioner.', exclude: ['sui_none', 'sui_active_thoughts'] },
            { id: 'sui_active_thoughts', label: 'Aktive selvmordstanker', category: 'Risikovurdering (Suic)', text: 'Tilkendegiver aktive selvmordstanker.', exclude: ['sui_none', 'sui_passive'] },
            { id: 'sui_plans', label: 'Konkrete planer', category: 'Risikovurdering (Suic)', text: 'Har udarbejdet konkrete planer for selvmord.', exclude: ['sui_none'] },
            { id: 'sui_intent', label: 'Aktuel intention', category: 'Risikovurdering (Suic)', text: 'Tilkendegiver intention om at handle på tankerne.', exclude: ['sui_none'] },
            { id: 'sui_prev', label: 'Tidl. forsøg', category: 'Risikovurdering (Suic)', text: 'Tidligere selvmordsforsøg i anamnesen.', summaryLabel: 'Tidl. suicidalforsøg' },
        ];

        const SOMATIC_OBJ_OPTIONS = [
            { id: 'gen_upavirket', label: 'Upåvirket', category: 'Almentilstand', text: 'Almentilstand upåvirket. Normal ernæringstilstand.', isDefault: true, exclude: ['gen_medtaget', 'gen_adipos', 'gen_emaciated'] },
            // Smart Merge General
            { id: 'gen_medtaget', label: 'Medtaget', category: 'Almentilstand', text: 'Fremstår kronisk medtaget.', exclude: ['gen_upavirket'], smartMerge: { prefix: 'Fremstår ', item: 'kronisk medtaget', suffix: '.' } },
            { id: 'gen_emaciated', label: 'Afmagret/Kakektisk', category: 'Almentilstand', text: 'Fremstår afmagret/kakektisk.', exclude: ['gen_upavirket', 'gen_adipos'], smartMerge: { prefix: 'Fremstår ', item: 'afmagret/kakektisk', suffix: '.' } },

            { id: 'gen_adipos', label: 'Adipositas', category: 'Almentilstand', text: 'Adipøs ernæringstilstand.', exclude: ['gen_upavirket', 'gen_emaciated'] },
            
            { id: 'cp_normal', label: 'St.c. et p. normal', category: 'Stethoscopia', text: 'St.c.: Regelmæssig hjerteaktion uden mislyde. St.p.: Vesikulær respiration uden bilyde.', isDefault: true, exclude: ['cp_abnorm_c', 'cp_abnorm_p'] },
            { id: 'cp_abnorm_c', label: 'St.c. uregelmæssig', category: 'Stethoscopia', text: 'St.c.: Uregelmæssig hjerteaktion (arytmi).', exclude: ['cp_normal'] },
            { id: 'cp_abnorm_p', label: 'St.p. bilyde', category: 'Stethoscopia', text: 'St.p.: Der høres bilyde (rhonchi/crepitatio).', exclude: ['cp_normal'] },

            { id: 'cn_normal', label: 'Kranienerver II-XII normal', category: 'Neurologisk (Kranienerver)', text: 'Kranienerver: Intet abnormt påvist, systematisk undersøgt (II-XII). Pupiller egale med normal lysrefleks. Ingen nystagmus. Ingen facialisparese. Ingen tungedeviation.', isDefault: true, exclude: ['cn_pupil', 'cn_nystag', 'cn_facial', 'cn_other'] },
            { id: 'cn_pupil', label: 'Pupilforhold afviger', category: 'Neurologisk (Kranienerver)', text: 'Pupiller: [Beskriv afvigelse, fx miosis/mydriasis].', exclude: ['cn_normal'] },
            // Smart Merge CN (Booleans)
            { id: 'cn_nystag', label: 'Nystagmus', category: 'Neurologisk (Kranienerver)', text: 'Der ses nystagmus.', exclude: ['cn_normal'], smartMerge: { prefix: 'Der ses ', item: 'nystagmus', suffix: '.' } },
            { id: 'cn_facial', label: 'Facialisparese', category: 'Neurologisk (Kranienerver)', text: 'Tegn på facialisparese (central/perifer).', exclude: ['cn_normal'], smartMerge: { prefix: 'Der ses ', item: 'facialisparese', suffix: '.' } },

            { id: 'motor_sys_normal', label: 'Motorik/Kraft normal', category: 'Neurologisk (Motorik)', text: 'Motorisk system: Strakt arm- og bentest uden nedsynkning. Egal kraft (5/5) over de større led (OE+UE). Normal tonus.', isDefault: true, exclude: ['motor_weak_oe', 'motor_weak_ue', 'motor_tonus'] },
            // Smart Merge Motor
            { id: 'motor_weak_oe', label: 'Kraftnedsættelse OE', category: 'Neurologisk (Motorik)', text: 'Nedsat kraft i overekstremiteter.', exclude: ['motor_sys_normal'], smartMerge: { prefix: 'Nedsat kraft i ', item: 'overekstremiteter', suffix: '.' } },
            { id: 'motor_weak_ue', label: 'Kraftnedsættelse UE', category: 'Neurologisk (Motorik)', text: 'Nedsat kraft i underekstremiteter.', exclude: ['motor_sys_normal'], smartMerge: { prefix: 'Nedsat kraft i ', item: 'underekstremiteter', suffix: '.' } },
            
            { id: 'reflex_normal', label: 'Reflekser normale (Alle)', category: 'Neurologisk (Reflekser)', text: 'Reflekser: Normale og sidelige dybe senereflekser. Babinski negativ bilat.', isDefault: true, exclude: ['reflex_hyper', 'reflex_babinski', 'reflex_biceps', 'reflex_triceps', 'reflex_brachiorad', 'reflex_patellar', 'reflex_achilles', 'reflex_babinski_neg'] },
            
            // SMART MERGE REFLEKSER
            { id: 'reflex_biceps', label: 'Biceps (Normal)', category: 'Neurologisk (Reflekser)', text: 'Biceps: bilat. normal.', isDefault: false, exclude: ['reflex_normal'], smartMerge: { prefix: 'Reflekser: ', item: 'biceps', suffix: ' findes bilat. normale.' } },
            { id: 'reflex_triceps', label: 'Triceps (Normal)', category: 'Neurologisk (Reflekser)', text: 'Triceps: bilat. normal.', isDefault: false, exclude: ['reflex_normal'], smartMerge: { prefix: 'Reflekser: ', item: 'triceps', suffix: ' findes bilat. normale.' } },
            { id: 'reflex_brachiorad', label: 'Brachioradialis (Normal)', category: 'Neurologisk (Reflekser)', text: 'Brachioradialis: bilat. normal.', isDefault: false, exclude: ['reflex_normal'], smartMerge: { prefix: 'Reflekser: ', item: 'brachioradialis', suffix: ' findes bilat. normale.' } },
            { id: 'reflex_patellar', label: 'Patellar (Normal)', category: 'Neurologisk (Reflekser)', text: 'Patellar: bilat. normal.', isDefault: false, exclude: ['reflex_normal'], smartMerge: { prefix: 'Reflekser: ', item: 'patellar', suffix: ' findes bilat. normale.' } },
            { id: 'reflex_achilles', label: 'Achilles (Normal)', category: 'Neurologisk (Reflekser)', text: 'Achilles: bilat. normal.', isDefault: false, exclude: ['reflex_normal'], smartMerge: { prefix: 'Reflekser: ', item: 'achilles', suffix: ' findes bilat. normale.' } },
            { id: 'reflex_babinski_neg', label: 'Babinski Neg.', category: 'Neurologisk (Reflekser)', text: 'Babinski: Negativ.', isDefault: false, exclude: ['reflex_normal'] },
            
            // Smart Merge Pathological Reflexes
            { id: 'reflex_hyper', label: 'Hyperrefleksi', category: 'Neurologisk (Reflekser)', text: 'Livlige/Hyperaktive reflekser.', exclude: ['reflex_normal'], smartMerge: { prefix: 'Der findes ', item: 'livlige/hyperaktive reflekser', suffix: '.' } },
            { id: 'reflex_babinski', label: 'Babinski Positiv', category: 'Neurologisk (Reflekser)', text: 'Babinski positiv (extensivt tå-respons).', exclude: ['reflex_normal'], smartMerge: { prefix: 'Der findes ', item: 'positiv Babinski (extensivt tå-respons)', suffix: '.' } },

            { id: 'coord_normal', label: 'Koordination normal', category: 'Neurologisk (Cerebellart)', text: 'Cerebellart: Normal koordination ved finger-næse forsøg og knæ-hæl forsøg. Ingen ataksi.', isDefault: true, exclude: ['coord_ataxia', 'coord_romberg'] },
            // Smart Merge Cerebellar
            { id: 'coord_ataxia', label: 'Ataksi/Usikker FNF', category: 'Neurologisk (Cerebellart)', text: 'Usikkerhed ved finger-næse forsøg (ataksi).', exclude: ['coord_normal'], smartMerge: { prefix: 'Der findes ', item: 'ataksi', suffix: '.' } },
            { id: 'coord_romberg', label: 'Romberg Positiv', category: 'Neurologisk (Cerebellart)', text: 'Rombergs test positiv (faldtendens ved lukkede øjne).', exclude: ['coord_normal'], smartMerge: { prefix: 'Der findes ', item: 'positiv Romberg', suffix: '.' } },
            
            { id: 'gait_normal', label: 'Gang/Stand normal', category: 'Neurologisk (Gang)', text: 'Gang og stand: Sikker gang, vending og stand. Linegang upåfaldende.', isDefault: true, exclude: ['gait_unsure', 'gait_broad'] },
            { id: 'gait_unsure', label: 'Usikker gang', category: 'Neurologisk (Gang)', text: 'Gangen er usikker/bredsporet.', exclude: ['gait_normal'] },

            { id: 'eps_none', label: 'Ingen EPS', category: 'Neurologisk (EPS)', text: 'Ekstrapyramidale system: Ingen bradykinesi, rigiditet eller ufrivillige bevægelser. Ingen hvile- eller intentionstremor.', isDefault: true, exclude: ['eps_rigid', 'eps_tremor', 'eps_dyskinesia', 'eps_aca'] },
            // Smart Merge EPS
            { id: 'eps_rigid', label: 'Rigiditet', category: 'Neurologisk (EPS)', text: 'Der findes rigiditet (tandhjulsrigiditet) ved passiv bevægelse.', exclude: ['eps_none'], smartMerge: { prefix: 'Der observeres ', item: 'rigiditet', suffix: '.' } },
            { id: 'eps_tremor', label: 'Tremor', category: 'Neurologisk (EPS)', text: 'Der observeres tremor (hvile/intention).', exclude: ['eps_none'], smartMerge: { prefix: 'Der observeres ', item: 'tremor', suffix: '.' } },
            { id: 'eps_dyskinesia', label: 'Dyskinesier', category: 'Neurologisk (EPS)', text: 'Der ses orofaciale dyskinesier.', exclude: ['eps_none'], smartMerge: { prefix: 'Der observeres ', item: 'dyskinesier', suffix: '.' } },
            { id: 'eps_aca', label: 'Akatisi', category: 'Neurologisk (EPS)', text: 'Motorisk urolig, tegn på akatisi.', exclude: ['eps_none'], smartMerge: { prefix: 'Der observeres ', item: 'akatisi', suffix: '.' } },

            { id: 'skin_normal', label: 'Hud: ingen mærker', category: 'Hud/Traumer', text: 'Ingen tegn på friske eller ældre læsioner eller injektionsmærker.', isDefault: true, exclude: ['skin_cut_fresh', 'skin_cut_old', 'skin_inject'] },
            // Smart Merge Skin
            { id: 'skin_cut_fresh', label: 'Friske snitsår', category: 'Hud/Traumer', text: 'Der ses friske overfladiske snitsår (lokalisation: ).', exclude: ['skin_normal'], smartMerge: { prefix: 'Der ses ', item: 'friske snitsår', suffix: '.' } },
            { id: 'skin_cut_old', label: 'Gamle ar', category: 'Hud/Traumer', text: 'Gamle ar efter selvskade (scars).', exclude: ['skin_normal'], smartMerge: { prefix: 'Der ses ', item: 'gamle ar', suffix: '.' } },
            { id: 'skin_inject', label: 'Injektionsmærker', category: 'Hud/Traumer', text: 'Injektionsmærker i lysken/albuebøjning.', exclude: ['skin_normal'], smartMerge: { prefix: 'Der ses ', item: 'injektionsmærker', suffix: '.' } },
        ];

        const SOMATIC_ACT_OPTIONS = [
            { id: 'act_cns_ok', label: 'Ingen CNS klager', category: 'CNS', text: 'CNS: Benægter hovedpine, svimmelhed, besvimelse, synsforstyrrelser eller kramper.', isDefault: true, exclude: ['act_cns_headache', 'act_cns_dizzy', 'act_cns_faint'] },
            
            // Smart Merge CNS
            { id: 'act_cns_headache', label: 'Hovedpine', category: 'CNS', text: 'CNS: Angiver hovedpine.', exclude: ['act_cns_ok'], smartMerge: { prefix: 'CNS: Angiver ', item: 'hovedpine', suffix: '.' } },
            { id: 'act_cns_dizzy', label: 'Svimmelhed', category: 'CNS', text: 'CNS: Angiver svimmelhed (karakter: ).', exclude: ['act_cns_ok'], smartMerge: { prefix: 'CNS: Angiver ', item: 'svimmelhed (karakter: )', suffix: '.' } },
            
            { id: 'act_cp_ok', label: 'Ingen CP klager', category: 'Cardio/Pulm', text: 'CP: Ingen klager over brystsmerter, hjertebanken eller dyspnø.', isDefault: true, exclude: ['act_cp_pain', 'act_cp_palp', 'act_cp_dysp'] },
            
            // Smart Merge CP
            { id: 'act_cp_pain', label: 'Brystsmerter', category: 'Cardio/Pulm', text: 'CP: Angiver brystsmerter.', exclude: ['act_cp_ok'], smartMerge: { prefix: 'CP: Angiver ', item: 'brystsmerter', suffix: '.' } },
            { id: 'act_cp_palp', label: 'Hjertebanken', category: 'Cardio/Pulm', text: 'CP: Angiver hjertebanken.', exclude: ['act_cp_ok'], smartMerge: { prefix: 'CP: Angiver ', item: 'hjertebanken', suffix: '.' } },
            { id: 'act_cp_dysp', label: 'Dyspnø', category: 'Cardio/Pulm', text: 'CP: Angiver dyspnø.', exclude: ['act_cp_ok'], smartMerge: { prefix: 'CP: Angiver ', item: 'dyspnø', suffix: '.' } },
            
            // --- UPDATED GI SECTION ---
            { id: 'act_gi_ok', label: 'Ingen GI klager', category: 'Gastro-Intestinal', text: 'GI: Ingen kvalme, opkastninger eller ændring i afføringsmønster.', isDefault: true, exclude: ['act_gi_nausea', 'act_gi_obst', 'act_gi_dia', 'act_gi_pain', 'act_gi_blood', 'act_gi_def_pain'] },
            
            // Smart Merge GI
            { id: 'act_gi_nausea', label: 'Kvalme', category: 'Gastro-Intestinal', text: 'GI: Angiver kvalme.', exclude: ['act_gi_ok'], smartMerge: { prefix: 'GI: Angiver ', item: 'kvalme', suffix: '.' } },
            { id: 'act_gi_obst', label: 'Obstipation', category: 'Gastro-Intestinal', text: 'GI: Angiver tendens til forstoppelse.', exclude: ['act_gi_ok'], smartMerge: { prefix: 'GI: Angiver ', item: 'tendens til forstoppelse', suffix: '.' } },
            { id: 'act_gi_dia', label: 'Diarré', category: 'Gastro-Intestinal', text: 'GI: Angiver diarré.', exclude: ['act_gi_ok'], smartMerge: { prefix: 'GI: Angiver ', item: 'diarré', suffix: '.' } },
            { id: 'act_gi_pain', label: 'Mavesmerter', category: 'Gastro-Intestinal', text: 'GI: Angiver mavesmerter.', exclude: ['act_gi_ok'], smartMerge: { prefix: 'GI: Angiver ', item: 'mavesmerter', suffix: '.' } },
            { id: 'act_gi_blood', label: 'Blod i afføring', category: 'Gastro-Intestinal', text: 'GI: Angiver blod i afføringen.', exclude: ['act_gi_ok'], smartMerge: { prefix: 'GI: Angiver ', item: 'blod i afføringen', suffix: '.' } },
            { id: 'act_gi_def_pain', label: 'Smerter v. afføring', category: 'Gastro-Intestinal', text: 'GI: Angiver smerter ved afføring.', exclude: ['act_gi_ok'], smartMerge: { prefix: 'GI: Angiver ', item: 'smerter ved afføring', suffix: '.' } },
            
            // --- UPDATED URO SECTION ---
            { id: 'act_uro_ok', label: 'Ingen URO klager', category: 'Urologisk', text: 'Uro: Ingen vandladningsgener (svie, hyppighed eller retention).', isDefault: true, exclude: ['act_uro_retention', 'act_uro_pain', 'act_uro_dysuria', 'act_uro_blood', 'act_uro_pollakisuria'] },
            // Smart Merge Uro
            { id: 'act_uro_retention', label: 'Retention', category: 'Urologisk', text: 'Uro: Oplever besvær med at lade vandet (retention).', exclude: ['act_uro_ok'], smartMerge: { prefix: 'Uro: Angiver ', item: 'retention', suffix: '.' } },
            { id: 'act_uro_dysuria', label: 'Svie/Smerter', category: 'Urologisk', text: 'Uro: Angiver svie/smerter ved vandladning.', exclude: ['act_uro_ok'], smartMerge: { prefix: 'Uro: Angiver ', item: 'svie/smerter ved vandladning', suffix: '.' } },
            { id: 'act_uro_blood', label: 'Blod i urin', category: 'Urologisk', text: 'Uro: Angiver synligt blod i urinen.', exclude: ['act_uro_ok'], smartMerge: { prefix: 'Uro: Angiver ', item: 'synligt blod i urinen', suffix: '.' } },
            { id: 'act_uro_pollakisuria', label: 'Hyppig vandladning', category: 'Urologisk', text: 'Uro: Angiver hyppig vandladning.', exclude: ['act_uro_ok'], smartMerge: { prefix: 'Uro: Angiver ', item: 'hyppig vandladning', suffix: '.' } },
            
            { id: 'act_musc_ok', label: 'Ingen smerter', category: 'Bevægeapparat', text: 'Bevægeapparat: Ingen aktuelle smerter eller bevægeindskrænkning.', isDefault: true, exclude: ['act_musc_back', 'act_musc_joint'] },
            
            // Smart Merge Musk
            { id: 'act_musc_back', label: 'Rygsmerter', category: 'Bevægeapparat', text: 'Bevægeapparat: Angiver rygsmerter.', exclude: ['act_musc_ok'], smartMerge: { prefix: 'Bevægeapparat: Angiver ', item: 'rygsmerter', suffix: '.' } },
            { id: 'act_musc_joint', label: 'Ledsmerter', category: 'Bevægeapparat', text: 'Bevægeapparat: Angiver ledsmerter.', exclude: ['act_musc_ok'], smartMerge: { prefix: 'Bevægeapparat: Angiver ', item: 'ledsmerter', suffix: '.' } },

            { id: 'act_sleep_ok', label: 'Søvn normal', category: 'Søvn', text: 'Søvn: Sover uforstyrret igennem natten, føler sig udhvilet.', isDefault: true, exclude: ['act_sleep_insom', 'act_sleep_broken', 'act_sleep_early'] },
            // Smart Merge Sleep (Somatic)
            { id: 'act_sleep_insom', label: 'Indsovningsbesvær', category: 'Søvn', text: 'Søvn: Angiver indsovningsbesvær.', exclude: ['act_sleep_ok'], smartMerge: { prefix: 'Søvn: Angiver ', item: 'indsovningsbesvær', suffix: '.' } },
            { id: 'act_sleep_broken', label: 'Afbrudt søvn', category: 'Søvn', text: 'Søvn: Mange opvågninger.', exclude: ['act_sleep_ok'], smartMerge: { prefix: 'Søvn: Angiver ', item: 'mange opvågninger', suffix: '.' } },
            { id: 'act_sleep_early', label: 'Tidlig opvågning', category: 'Søvn', text: 'Søvn: Vågner tidligt uden at kunne falde i søvn igen (terminal insomni).', exclude: ['act_sleep_ok'], smartMerge: { prefix: 'Søvn: Angiver ', item: 'tidlig opvågning', suffix: '.' } },

            { id: 'act_appetite_ok', label: 'Appetit normal', category: 'Appetit/Vægt', text: 'Appetit: Normal appetit og stabil vægt.', isDefault: true, exclude: ['act_appetite_low', 'act_appetite_high', 'act_weight_loss'] },
            // Smart Merge Appetite
            { id: 'act_appetite_low', label: 'Nedsat appetit', category: 'Appetit/Vægt', text: 'Appetit: Nedsat lyst til mad.', exclude: ['act_appetite_ok'], smartMerge: { prefix: 'Appetit/Vægt: Angiver ', item: 'nedsat appetit', suffix: '.' } },
            { id: 'act_weight_loss', label: 'Vægttab', category: 'Appetit/Vægt', text: 'Vægt: Angiver utilsigtet vægttab.', exclude: ['act_appetite_ok'], smartMerge: { prefix: 'Appetit/Vægt: Angiver ', item: 'vægttab', suffix: '.' } },
        ];

        // --- APP KOMPONENT ---
        function App() {
            const [activeSection, setActiveSection] = useState('psych_actual');
            const [selectedIds, setSelectedIds] = useState(new Set());
            const [optionDetails, setOptionDetails] = useState({}); // New: Store text details for options
            const [generatedText, setGeneratedText] = useState('');
            const [isFullscreen, setIsFullscreen] = useState(false);
            const [notification, setNotification] = useState(null);
            const [showSummary, setShowSummary] = useState(false);
            
            // Initial load
            useEffect(() => {
                const defaults = new Set();
                [...PSYCH_OPTIONS, ...SOMATIC_OBJ_OPTIONS, ...SOMATIC_ACT_OPTIONS, ...ACTUAL_PSYCH_OPTIONS].forEach(opt => {
                    if (opt.isDefault) defaults.add(opt.id);
                });
                setSelectedIds(defaults);
            }, []);

            useEffect(() => {
                generateText();
            }, [selectedIds, activeSection, showSummary, optionDetails]); // Add optionDetails as dep

            const toggleOption = (option) => {
                const newSelection = new Set(selectedIds);
                if (newSelection.has(option.id)) {
                    newSelection.delete(option.id);
                    // Clear detail if deselected? Maybe keep it in case of accidental click.
                } else {
                    newSelection.add(option.id);
                    option.exclude?.forEach(exId => newSelection.delete(exId));
                }
                setSelectedIds(newSelection);
            };

            const handleDetailChange = (id, value) => {
                setOptionDetails(prev => ({ ...prev, [id]: value }));
            };
            
            const clearAll = () => {
                setSelectedIds(new Set());
                setOptionDetails({});
                setNotification({ message: 'Alle felter ryddet', type: 'success' });
                setTimeout(() => setNotification(null), 3000);
            };
            
            const formatList = (items) => {
                if (items.length === 0) return '';
                if (items.length === 1) return items[0];
                const last = items.pop();
                return items.join(', ') + ' og ' + last;
            };

            const formatWithDetail = (text, detail) => {
                if (!detail || detail.trim() === '') return text;
                // Simple heuristic: remove trailing period, add parens, add period back.
                const cleanText = text.replace(/\.$/, '');
                return `${cleanText} (${detail}).`;
            };

            const processCategoryOptions = (categoryOptions) => {
                const lines = [];
                const smartMergeGroups = {}; // Key: JSON(prefix+suffix), Value: Array of items
                const standardOptions = [];

                categoryOptions.forEach(opt => {
                    const detail = optionDetails[opt.id];
                    
                    if (opt.smartMerge && !opt.isDefault) {
                        const key = JSON.stringify({ p: opt.smartMerge.prefix, s: opt.smartMerge.suffix });
                        if (!smartMergeGroups[key]) smartMergeGroups[key] = [];
                        
                        // Append detail to the item part of the smart merge
                        let itemText = opt.smartMerge.item;
                        if (detail && detail.trim() !== '') {
                            itemText += ` (${detail})`;
                        }
                        smartMergeGroups[key].push(itemText);
                    } else {
                        standardOptions.push({ ...opt, detail });
                    }
                });

                // Process Smart Merge Groups
                Object.keys(smartMergeGroups).forEach(key => {
                    const { p, s } = JSON.parse(key);
                    const items = smartMergeGroups[key];
                    if (items.length > 0) {
                        lines.push(`${p}${formatList(items)}${s}`);
                    }
                });

                // Process Standard Options
                standardOptions.forEach(opt => {
                     lines.push(formatWithDetail(opt.text, opt.detail));
                });

                return lines.join(' ');
            };

            const generateText = () => {
                const allSections = [
                    { id: 'psych_actual', title: 'AKTUELT PSYKISK', options: ACTUAL_PSYCH_OPTIONS },
                    { id: 'psych', title: 'OBJEKTIVT PSYKISK', options: PSYCH_OPTIONS },
                    { id: 'somatic_act', title: 'AKTUELT SOMATISK', options: SOMATIC_ACT_OPTIONS },
                    { id: 'somatic_obj', title: 'SOMATISK VURDERING', options: SOMATIC_OBJ_OPTIONS }
                ];

                let sectionsToRender = [];
                if (activeSection === 'full_note') {
                    sectionsToRender = allSections;
                } else {
                    sectionsToRender = allSections.filter(s => s.id === activeSection);
                }

                const lines = [];
                const movedCategories = new Set(); 

                // 1. Handle "OBSERVATIONER" (Summary)
                if (showSummary) {
                    const obsLines = [];
                    sectionsToRender.forEach(sec => {
                        const categories = Array.from(new Set(sec.options.map(o => o.category)));
                        
                        categories.forEach(cat => {
                            const selectedOptions = sec.options.filter(o => o.category === cat && selectedIds.has(o.id));
                            const hasAbnormality = selectedOptions.some(o => !o.isDefault);
                            
                            if (hasAbnormality && selectedOptions.length > 0) {
                                const text = processCategoryOptions(selectedOptions);
                                obsLines.push(`${cat}: ${text}`);
                                movedCategories.add(cat);
                            }
                        });
                    });

                    if (obsLines.length > 0) {
                        lines.push("OBSERVATIONER");
                        lines.push(...obsLines);
                        lines.push("");
                        lines.push("---");
                        lines.push(""); 
                    }
                }

                // 2. Handle Main Sections
                sectionsToRender.forEach(sec => {
                    const sectionLines = [];
                    const categories = Array.from(new Set(sec.options.map(o => o.category)));

                    categories.forEach(cat => {
                        if (movedCategories.has(cat)) return;

                        const selectedOptions = sec.options.filter(o => o.category === cat && selectedIds.has(o.id));
                        
                        if (selectedOptions.length > 0) {
                            const text = processCategoryOptions(selectedOptions);
                            sectionLines.push(`${cat}: ${text}`);
                        }
                    });

                    if (sectionLines.length > 0) {
                        lines.push(sec.title);
                        lines.push(...sectionLines);
                        lines.push(""); 
                    }
                });

                setGeneratedText(lines.join('\n'));
            };

            const copyToClipboard = () => {
                navigator.clipboard.writeText(generatedText);
                setNotification({ message: 'Tekst kopieret til udklipsholder', type: 'success' });
                setTimeout(() => setNotification(null), 3000);
            };

            const resetSection = () => {
                let currentOptions = [];
                if (activeSection === 'psych_actual') currentOptions = ACTUAL_PSYCH_OPTIONS;
                else if (activeSection === 'psych') currentOptions = PSYCH_OPTIONS;
                else if (activeSection === 'somatic_obj') currentOptions = SOMATIC_OBJ_OPTIONS;
                else if (activeSection === 'somatic_act') currentOptions = SOMATIC_ACT_OPTIONS;
                else if (activeSection === 'full_note') {
                   currentOptions = [...ACTUAL_PSYCH_OPTIONS, ...PSYCH_OPTIONS, ...SOMATIC_ACT_OPTIONS, ...SOMATIC_OBJ_OPTIONS];
                }
                
                const newSet = new Set(selectedIds);
                // Also clear details for these options
                const newDetails = { ...optionDetails };
                
                currentOptions.forEach(o => {
                    newSet.delete(o.id);
                    delete newDetails[o.id];
                });
                currentOptions.filter(o => o.isDefault).forEach(o => newSet.add(o.id));
                
                setSelectedIds(newSet);
                setOptionDetails(newDetails);
            };

            const toggleFullscreen = () => {
                 if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().catch((err) => {
                        console.error(err);
                        setNotification({ message: 'Fuldskærm blokeret af browseren', type: 'error' });
                        setTimeout(() => setNotification(null), 3000);
                    });
                    setIsFullscreen(true);
                } else {
                    document.exitFullscreen();
                    setIsFullscreen(false);
                }
            };
            
             useEffect(() => {
                const handleFsChange = () => {
                    setIsFullscreen(!!document.fullscreenElement);
                };
                document.addEventListener('fullscreenchange', handleFsChange);
                return () => document.removeEventListener('fullscreenchange', handleFsChange);
            }, []);


            const renderCardGrid = (dataSet) => {
                const categories = Array.from(new Set(dataSet.map(o => o.category)));
                
                return (
                    <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 pb-20">
                        {categories.map(cat => (
                            <div key={cat} className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col h-full">
                                <div className="bg-slate-50 px-4 py-3 border-b border-slate-200 flex items-center justify-between">
                                    <h3 className="font-semibold text-slate-700 text-sm uppercase tracking-wide">{cat}</h3>
                                    {dataSet.filter(o => o.category === cat && !o.isDefault && selectedIds.has(o.id)).length > 0 && (
                                        <AlertCircle className="w-4 h-4 text-red-500" />
                                    )}
                                </div>
                                <div className="p-4 flex flex-col gap-2">
                                    {dataSet.filter(o => o.category === cat).map(option => {
                                        const isSelected = selectedIds.has(option.id);
                                        const isPathology = !option.isDefault;
                                        
                                        let btnClass = "w-full text-left px-3 py-2.5 text-sm rounded-lg border transition-all duration-200 flex items-center justify-between group ";
                                        
                                        if (isSelected) {
                                            if (isPathology) {
                                                btnClass += "bg-red-50 border-red-200 text-red-900 shadow-sm";
                                            } else {
                                                btnClass += "bg-emerald-50 border-emerald-200 text-emerald-900 shadow-sm";
                                            }
                                        } else {
                                            btnClass += "bg-white border-transparent hover:bg-slate-50 text-slate-600 hover:text-slate-900";
                                        }

                                        return (
                                            <div key={option.id}>
                                                <button onClick={() => toggleOption(option)} className={btnClass}>
                                                    <span className="truncate pr-2">{option.label}</span>
                                                    {isSelected && (
                                                        isPathology ? 
                                                        <AlertCircle className="w-4 h-4 text-red-600 flex-shrink-0" /> : 
                                                        <CheckCircle2 className="w-4 h-4 text-emerald-600 flex-shrink-0" />
                                                    )}
                                                </button>
                                                {/* Fritekstfelt kun for patologiske fund der er valgt */}
                                                {isSelected && isPathology && (
                                                    <div className="mt-1 mb-1 ml-1 pl-2 border-l-2 border-slate-200">
                                                        <input 
                                                            type="text" 
                                                            placeholder="Uddybning..." 
                                                            className="w-full text-xs p-1.5 bg-slate-50 border border-slate-200 rounded focus:outline-none focus:border-indigo-400 focus:bg-white transition-colors"
                                                            value={optionDetails[option.id] || ''}
                                                            onChange={(e) => handleDetailChange(option.id, e.target.value)}
                                                            onClick={(e) => e.stopPropagation()}
                                                        />
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        ))}
                    </div>
                );
            };

            return (
                <div className="flex flex-col h-screen bg-slate-100 text-slate-900 font-sans overflow-hidden relative">
                    
                    {notification && (
                        <div className={`absolute top-16 left-1/2 transform -translate-x-1/2 z-50 px-4 py-3 rounded-lg shadow-lg flex items-center gap-3 transition-all duration-300 ${
                            notification.type === 'error' ? 'bg-red-600 text-white' : 'bg-slate-800 text-white'
                        }`}>
                            {notification.type === 'error' ? <XCircle className="h-5 w-5" /> : <CheckCircle2 className="h-5 w-5" />}
                            <span className="text-sm font-medium">{notification.message}</span>
                        </div>
                    )}

                    <header className="bg-white border-b border-slate-200 px-6 py-3 flex justify-between items-center shadow-sm shrink-0 z-20">
                        <div className="flex items-center gap-3">
                            <div className="bg-indigo-600 p-1.5 rounded-lg">
                                <Activity className="text-white h-5 w-5" />
                            </div>
                            <div>
                                <h1 className="text-lg font-bold text-slate-800 leading-tight">Psykiatrisk Phrase Generator</h1>
                                <p className="text-xs text-slate-500">Klinisk dokumentationsstøtte</p>
                            </div>
                        </div>
                        <div className="flex items-center gap-4">
                            
                            {/* Clear All Button */}
                            <button 
                                type="button"
                                onClick={clearAll}
                                className="flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm font-medium transition-colors bg-white text-red-600 border border-red-200 hover:bg-red-50 hover:border-red-300 cursor-pointer"
                                title="Fjern alle markeringer (Tomt resultat)"
                            >
                                <Trash2 className="w-5 h-5" />
                                <span>Ryd alt</span>
                            </button>

                            {/* Toggle for Summary Mode */}
                            <button 
                                type="button"
                                onClick={() => setShowSummary(!showSummary)}
                                className={`flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm font-medium transition-colors border cursor-pointer ${showSummary ? 'bg-slate-800 text-white border-slate-800' : 'bg-white text-slate-600 border-slate-200 hover:border-slate-300'}`}
                                title="Vis opsummering af fund øverst i notatet"
                            >
                                {showSummary ? <ToggleRight className="w-5 h-5 text-emerald-400" /> : <ToggleLeft className="w-5 h-5 text-slate-400" />}
                                <span>Vis fund øverst</span>
                            </button>

                            <div className="h-6 w-px bg-slate-200 mx-1"></div>

                            <button onClick={toggleFullscreen} className="p-2 text-slate-500 hover:text-indigo-600 hover:bg-slate-100 rounded-lg transition-colors cursor-pointer" title={isFullscreen ? "Afslut fuldskærm" : "Fuldskærm"}>
                                {isFullscreen ? <Minimize className="h-5 w-5" /> : <Maximize className="h-5 w-5" />}
                            </button>
                        </div>
                    </header>

                    <div className="flex flex-1 overflow-hidden">
                        <nav className="w-64 bg-slate-50 border-r border-slate-200 flex flex-col flex-shrink-0 z-10 overflow-y-auto">
                            <div className="p-4 space-y-2">
                                <button onClick={() => setActiveSection('psych_actual')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl text-left transition-all duration-200 ${activeSection === 'psych_actual' ? 'bg-white text-indigo-700 shadow ring-1 ring-slate-200' : 'text-slate-600 hover:bg-slate-100'}`}>
                                    <MessageSquare className={`h-5 w-5 ${activeSection === 'psych_actual' ? 'text-indigo-600' : 'text-slate-400'}`} />
                                    <span className="font-medium">Aktuelt Psykisk</span>
                                </button>
                                <button onClick={() => setActiveSection('psych')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl text-left transition-all duration-200 ${activeSection === 'psych' ? 'bg-white text-indigo-700 shadow ring-1 ring-slate-200' : 'text-slate-600 hover:bg-slate-100'}`}>
                                    <Brain className={`h-5 w-5 ${activeSection === 'psych' ? 'text-indigo-600' : 'text-slate-400'}`} />
                                    <span className="font-medium">Objektivt Psykisk</span>
                                </button>
                                <button onClick={() => setActiveSection('somatic_act')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl text-left transition-all duration-200 ${activeSection === 'somatic_act' ? 'bg-white text-indigo-700 shadow ring-1 ring-slate-200' : 'text-slate-600 hover:bg-slate-100'}`}>
                                    <FileText className={`h-5 w-5 ${activeSection === 'somatic_act' ? 'text-indigo-600' : 'text-slate-400'}`} />
                                    <span className="font-medium">Aktuelt Somatisk</span>
                                </button>
                                <button onClick={() => setActiveSection('somatic_obj')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl text-left transition-all duration-200 ${activeSection === 'somatic_obj' ? 'bg-white text-indigo-700 shadow ring-1 ring-slate-200' : 'text-slate-600 hover:bg-slate-100'}`}>
                                    <Stethoscope className={`h-5 w-5 ${activeSection === 'somatic_obj' ? 'text-indigo-600' : 'text-slate-400'}`} />
                                    <span className="font-medium">Somatisk Vurdering</span>
                                </button>
                                <div className="h-px bg-slate-200 my-2"></div>
                                <button onClick={() => setActiveSection('full_note')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl text-left transition-all duration-200 ${activeSection === 'full_note' ? 'bg-slate-800 text-white shadow ring-1 ring-slate-900' : 'text-slate-700 bg-slate-200 hover:bg-slate-300'}`}>
                                    <Layers className={`h-5 w-5 ${activeSection === 'full_note' ? 'text-emerald-400' : 'text-slate-600'}`} />
                                    <span className="font-bold">Samlet Notat</span>
                                </button>
                            </div>
                            <div className="mt-auto p-4 border-t border-slate-200">
                                <div className="bg-indigo-50 rounded-lg p-3 text-xs text-indigo-900">
                                    <strong>Tip:</strong> Røde markeringer indikerer patologiske fund. Grønne er normalfund.
                                </div>
                            </div>
                        </nav>

                        <main className="flex-1 overflow-y-auto bg-slate-100 p-6">
                            <div className="max-w-6xl mx-auto">
                                <div className="flex justify-between items-center mb-6">
                                    <div>
                                        <h2 className="text-xl font-bold text-slate-800">
                                            {activeSection === 'psych_actual' && 'Aktuelt Psykisk (Anamnese)'}
                                            {activeSection === 'psych' && 'Klinisk vurdering (Psykisk)'}
                                            {activeSection === 'somatic_obj' && 'Somatisk Vurdering'}
                                            {activeSection === 'somatic_act' && 'Somatisk Anamnese'}
                                            {activeSection === 'full_note' && 'Samlet Journalnotat (Oversigt)'}
                                        </h2>
                                        <p className="text-sm text-slate-500 mt-1">
                                            {activeSection === 'full_note' ? 'Her ses det samlede notat. Brug menuen til venstre for at redigere indholdet.' : 'Vælg relevante observationer. Standardværdier er præ-selekterede.'}
                                        </p>
                                    </div>
                                    <button onClick={resetSection} className="flex items-center gap-2 px-3 py-2 text-sm font-medium text-slate-600 bg-white border border-slate-200 rounded-lg hover:bg-slate-50 hover:text-indigo-600 transition-colors shadow-sm">
                                        <RotateCcw className="h-4 w-4" /> Nulstil
                                    </button>
                                </div>
                                {activeSection === 'psych_actual' && renderCardGrid(ACTUAL_PSYCH_OPTIONS)}
                                {activeSection === 'psych' && renderCardGrid(PSYCH_OPTIONS)}
                                {activeSection === 'somatic_act' && renderCardGrid(SOMATIC_ACT_OPTIONS)}
                                {activeSection === 'somatic_obj' && renderCardGrid(SOMATIC_OBJ_OPTIONS)}
                                {activeSection === 'full_note' && (
                                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-10 flex flex-col items-center justify-center text-center h-96">
                                        <Layers className="h-16 w-16 text-slate-200 mb-4" />
                                        <h3 className="text-lg font-medium text-slate-800">Samlet Visning</h3>
                                        <p className="text-slate-500 max-w-md mt-2">
                                            Tekstboksen til højre viser nu det komplette notat samlet fra alle sektioner.
                                            <br/><br/>
                                            Gå til de enkelte sektioner i menuen til venstre for at redigere indholdet.
                                        </p>
                                    </div>
                                )}
                            </div>
                        </main>

                        <aside className="w-80 xl:w-96 bg-white border-l border-slate-200 flex flex-col shadow-xl z-20 flex-shrink-0">
                            <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                                <div className="flex items-center gap-2">
                                    <FileText className="h-4 w-4 text-slate-500" />
                                    <h3 className="font-semibold text-slate-700 text-sm uppercase tracking-wide">
                                        {activeSection === 'full_note' ? 'Hele Notatet' : 'Resultat (Sektion)'}
                                    </h3>
                                </div>
                                {showSummary && <span className="text-xs bg-emerald-100 text-emerald-800 px-2 py-0.5 rounded-full font-medium">Resume aktivt</span>}
                            </div>
                            <div className="flex-1 relative">
                                <textarea 
                                    className="absolute inset-0 w-full h-full p-5 border-none resize-none focus:ring-0 text-sm leading-relaxed text-slate-800 font-mono bg-white focus:outline-none"
                                    value={generatedText}
                                    onChange={(e) => setGeneratedText(e.target.value)}
                                    spellCheck="false"
                                ></textarea>
                            </div>
                            <div className="p-4 bg-slate-50 border-t border-slate-200">
                                <button onClick={copyToClipboard} className="w-full flex justify-center items-center gap-2 bg-slate-900 hover:bg-slate-800 text-white px-4 py-3 rounded-lg font-medium transition-all shadow-lg hover:shadow-xl active:transform active:scale-95">
                                    <Clipboard className="h-4 w-4" /> 
                                    {activeSection === 'full_note' ? 'Kopier HELE notatet' : 'Kopier SEKTION'}
                                </button>
                            </div>
                        </aside>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
